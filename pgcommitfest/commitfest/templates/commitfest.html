{%extends "base.html"%}
{%load commitfest %}
{%block contents%}

<button type="button" class="btn btn-default{%if has_filter%} active{%endif%}" id="filterButton" onClick="toggleButtonCollapse('filterButton', 'collapseFilters')">Search/filter</button>
<div class="btn-group">
  <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="#">Shortcuts <span class="caret"></span></a>
  <ul class="dropdown-menu">
    <li><a href="?reviewer=-2">Patches with no reviewers</a></li>
    <li><a href="?author=-3">Patches where you are author</a></li>
    <li><a href="?reviewer=-3">Patches where you are reviwer</a></li>
  </ul>
</div>
<div id="collapseFilters" class="collapse {%if has_filter%}in{%endif%}">
    <form id="filterform" method="GET" action="." style="margin-bottom: 0px">
      <table class="table table-condensed" style="margin-bottom: 0px">
	<thead>
	  <tr>
{%for f in form%}{%if not f.is_hidden%}
            <td>{{f.label}}</td>
{%endif%}{%endfor%}
	    <td></td>
	  </tr>
	</thead>
	<tbody>
	  <tr>
{%for f in form%}
            <td>{{f|field_class:"form-control"}}</td>
{%endfor%}
	    <td>
	      <input type="submit" class="btn btn-default" value="Filter">
	      <a class="btn btn-default" href=".">Clear</a>
	    </td>
	  </tr>
	</tbody>
      </table>
    </form>
</div>

{%for p in patches %}
{%ifchanged p.is_open%}
{%if not forloop.first%}
 </tbody>
</table>
{%endif%}
<h3>{{p.is_open|yesno:"Active patches,Closed patches"}}</h3>
<table class="table table-striped table-bordered table-hover table-condensed">
 <thead>
  <tr>
   <th>{%if p.is_open%}<a href="#" style="color:#333333;" onclick="return sortpatches(0);">Patch</a>{%if sortkey = 0%}<div style="float:right;"><i class="glyphicon glyphicon-arrow-down"></i></div>{%endif%}{%endif%}</th>
   <th>Status</th>
   <th>Author</th>
   <th>Reviewers</th>
   <th>{%if p.is_open%}<a href="#" style="color:#333333;" onclick="return sortpatches(1);">Latest activity</a>{%if sortkey = 1%}<div style="float:right;"><i class="icon-arrow-down"></i></div>{%endif%}{%else%}Latest activity{%endif%}</th>
   <th>{%if p.is_open%}<a href="#" style="color:#333333;" onclick="return sortpatches(2);">Latest mail</a>{%if sortkey = 2%}<div style="float:right;"><i class="icon-arrow-down"></i></div>{%endif%}{%else%}Latest mail{%endif%}</th>
{%if user.is_staff%}
   <th>Select</th>
{%endif%}
  </tr>
 </thead>
 <tbody>
{%endifchanged%}

{%if grouping%}
{%ifchanged p.topic%}
  <tr><th colspan="{%if user.is_staff%}7{%else%}6{%endif%}">{{p.topic}}</th></tr>
{%endifchanged%} 
{%endif%}
  <tr>
   <td><a href="{{p.id}}/">{{p}}</a></td>
   <td><span class="label label-default">{{p.status|patchstatusstring}}</span></td>
   <td>{{p.author_names|default:''}}</td>
   <td>{{p.reviewer_names|default:''}}</td>
   <td style="white-space: nowrap;">{{p.modified|date:"Y-m-d"}}<br/>{{p.modified|date:"H:i"}}</td>
   <td style="white-space: nowrap;">{{p.lastmail|date:"Y-m-d"}}<br/>{{p.lastmail|date:"H:i"}}</td>
{%if user.is_staff%}
   <td style="white-space: nowrap;"><input type="checkbox" class="sender_checkbox" id="send_authors_{{p.id}}">Author<br/><input type="checkbox" class="sender_checkbox" id="send_reviewers_{{p.id}}">Reviewer</td>
{%endif%}
  </tr>
{%endfor%}
 </tbody>
</table>

<div>
{%if cf.isopen or user.is_staff %}
<a class="btn btn-default" href="new/">New patch</a>
{%endif%}
{%if user.is_staff%}
 <div class="btn-group dropup">
  <button type="button" class="btn btn-default dropdown-toggle " data-toggle="dropdown" href="#">Send mail <span class="caret"></span></button>
  <ul class="dropdown-menu">
    <li><a href="javascript:send_selected()">Selected</a></li>
    <li><a href="send_email/?reviewers={{openpatchids|join:","}}">All reviewers (open patches)</a></li>
    <li><a href="send_email/?authors={{openpatchids|join:","}}">All authors (open patches)</a></li>
    <li><a href="send_email/?authors={{openpatchids|join:","}}&reviewers={{openpatchids|join:","}}">All authors and reviewers (open patches)</a></li>
  </ul>
 </div>
{%endif%}
</div>
{%endblock%}

{%block morescript%}
<script language="javascript">
{%if user.is_staff%}
   function send_selected() {
      var authors = [];
      var reviewers = [];
      $('input.sender_checkbox').each(function(index, el) {
         if (el.checked) {
            if (el.id.indexOf('send_authors_') == 0) {
               authors.push(el.id.substring(13));
            } else {
               reviewers.push(el.id.substring(15));
            }
         }
      });
      if (authors.length==0 && reviewers.length==0) {
         alert('Nothing to send.');
         return;
      }
      document.location.href = 'send_email/?authors=' + authors.join(',') + '&reviewers=' + reviewers.join(',');
   }
{%endif%}
</script>
{%endblock%}
